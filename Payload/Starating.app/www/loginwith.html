<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
        <!--  , height=device-height -->
        <link rel="stylesheet" type="text/css" href="css/index.css" />
        <title>Welcome</title>
        <script type="text/javascript" src="cordova.js"></script>

        <script src="js/lib/require.js"></script>
        <script src="js/config.js"></script>
        <script type="text/javascript" src="js/lib/phonegap.facebook.inappbrowser.js"></script>

        <script type="text/javascript" charset="utf-8">

            // Wait for device API libraries to load
            //
            function onLoad() {
                document.addEventListener("deviceready", onDeviceReady, false);
            }

            // device APIs are available
            //
            function onDeviceReady() {
                // Now safe to use device APIs
                navigator.splashscreen.hide();
                // window.cache.clear( function(s){alert('cleared cache');}, function(s){console.log("error clearing cache"); alert('error clearing cache');} );
                window.requestFileSystem(LocalFileSystem.PERSISTENT, 0, FileIO.gotFS, FileIO.errorHandler);
            }

            // set some globals
            var gImageURI = '';
            var gFileSystem = {};
            var url1, url2;
            var outFilePath;
            var isIOS2 = true;
             
            var FileIO = {
             
            // sets the filesystem to the global var gFileSystem
             gotFS : function(fileSystem) {
                  gFileSystem = fileSystem;
                  console.log(gFileSystem);
             },

            setFav:function(slug) {
              console.log(cordova.file.applicationDirectory);
              console.log(cordova.file.dataDirectory);
              // alert(cordova.file.dataDirectory);
              if (isIOS2) {
                window.resolveLocalFileSystemURL(cordova.file.applicationDirectory+'www/img/bgs/'+slug+'.png',FileIO.onGetFileWin,FileIO.onGetFileFail);
              } else {
                /* FOR ANDROID ONLY */
                window.resolveLocalFileSystemURL(cordova.file.dataDirectory+'www/img/bgs/'+slug+'.png',FileIO.onGetFileWin,FileIO.onGetFileFail);
              }
            },

            onGetFileWin:function(fileEntry) {
              console.log("got the file");
              // alert("got the file");
              //dataDir1 = gFileSystem.root.getDirectory("img", {create: false});
              url1 = fileEntry;
              // window.resolveLocalFileSystemURL(cordova.file.applicationDirectory+'www/img/',FileIO.onGetFileWin2,FileIO.onGetFileFail);
              if (cordova.file.documentsDirectory) {
                outFilePath = cordova.file.documentsDirectory+'/NoCloud/';
              } else {
                outFilePath = cordova.file.dataDirectory;
              }
              window.resolveLocalFileSystemURL(outFilePath,FileIO.onGetFileWin2,FileIO.onGetFileFail);
              // fileEntry.copyTo(cordova.file.applicationDirectory+'www/img/bgs/chelsea.png', "favbg.png", FileIO.success, FileIO.errorHandler);
            },

            onGetFileWin2:function(fileEntry) {
              console.log("got the folder");
              // alert("got the folder");
              url2 = fileEntry;
              // window.resolveLocalFileSystemURL(cordova.file.applicationDirectory+'www/img/favbg.png',FileIO.onGetFileWin3,FileIO.favbgNonexistent);
              window.resolveLocalFileSystemURL(outFilePath+'/favbg.png',FileIO.onGetFileWin3,FileIO.favbgNonexistent);
              // url1.copyTo(fileEntry, "favbg2.png", FileIO.success, FileIO.errorHandler);
            },

            onGetFileWin3:function(fileEntry) {
              console.log("got the existent favbg");
              // alert("got the existent favbg");
              fileEntry.remove(FileIO.onGetFileWin4, FileIO.favbgNonexistent);
            },

            onGetFileWin4:function(fileEntry) {
              console.log("removed the existent favbg");
              // alert("removed the existent favbg");
              url1.copyTo(url2, "favbg.png", FileIO.success, FileIO.errorHandler);
            },

            onGetFileFail:function(e) {
              console.log("failed to get file");
              console.log(e);
              // alert("failed to get file");
              // alert(e);
              window.location.href = "dashboard.html";
            },

            favbgNonexistent:function(e) {
              FileIO.onGetFileWin4();
            },

            success:function() {
              console.log("copied the file");
              // alert("copied file");
              window.localStorage.setItem('rndm', "1");
              window.cache.clear( function(s){console.log('cleared cache');}, function(s){console.log("error clearing cache");} );
              window.location.href = "dashboard.html?random="+Math.random();
            },
             
            // simple error handler
             errorHandler : function(e) {
                   var msg = '';
                   switch (e.code) {
                   case FileError.QUOTA_EXCEEDED_ERR:
                           msg = 'QUOTA_EXCEEDED_ERR';
                           break;
                    case FileError.NOT_FOUND_ERR:
                           msg = 'NOT_FOUND_ERR';
                           break;
                    case FileError.SECURITY_ERR:
                           msg = 'SECURITY_ERR';
                           break;
                    case FileError.INVALID_MODIFICATION_ERR:
                           msg = 'INVALID_MODIFICATION_ERR';
                           break;
                    case FileError.INVALID_STATE_ERR:
                           msg = 'INVALID_STATE_ERR';
                           break;
                    default:
                           msg = e.code;
                    break;
             };
                   console.log('Error: ' + msg);
                   console.log(e);
                   // alert(e);
                   window.location.href = "dashboard.html";
             }
            }

        </script>

        <script type="text/javascript">
          require(['jquery', 'index', 'user', 'rest', 'hello', 'login', 'general' ], function ($, app, user, rest, hello, login, general) {
              //app.initialize();
              if (user.checkAuth(false)) {
                tid = user.getUser().team_id;
                rest.get('squad/getTeam/'+tid,'').done(function(data){
                  if (cordova.file) {
                    FileIO.setFav(data.slug);
                  } else {
                    window.location.href = "dashboard.html";
                  }
                  
                });
                // FileIO.setFav();
                // window.location.href = "dashboard.html";
                /*if (navigator.splashscreen) {
                    setTimeout(navigator.splashscreen.hide(), 2000);
                }*/
              } else {

                var socailProvider = '';

                function loginHandler(r){
                  //  log(r);
                  console.log("loginHandler");
                  console.log(r);
                  // hello(r.network).api('me').on('complete', log);
                  hello(r.network).api('me').then(log, logError);
                }

                function log(r){
                    console.log('this is r' + JSON.stringify(r));
                    if (r.error) {
                        console.log('had error');
                        console.log(r);
                        return;
                    }
                    r.network = socailProvider;
                    user.socialLogin(r, FileIO);
                }

                function logError(r){
                  console.log('logError');
                  console.log(r);
                }

                function loginHandlerFB(r){
                  if(r.error){
                     console.log(r);
                     console.log(r.error);
                     console.log("has error");
                     general.hideLoader();
                     // return;
                  }
                  // log(r);
                  // hello(r.network).api('me').on('complete', log);
                  // hello(r.network).api('me').then(log, logError);
                  // facebookConnectPlugin.api('me', log, logError);
                  FacebookInAppBrowser.getInfo(function(response) {
                      if(response) {
                        // check the response object to see all available data like email, first name, last name, etc
                        console.log("response");
                          console.log(JSON.stringify(response));
                          log(response);
                      } else {
                        general.hideLoader();
                      }
                  });
                }

                $('#fb').on('click', function(){
                  general.showLoader();
                  console.log(localStorage);
                  // hello.init({
                  //   facebook : '958239604218546',
                  //   twitter: 'NFISj1ntdDXIEKKDfD6uY8Ecs'
                  // }, {
                  //   // redirect_uri : document.URL
                  //   // redirect_uri : 'http://162.13.45.102/starating/StaRatingAPI/public/social/redirect2'
                  //   redirect_uri : 'http://starating.net/starating/StaRatingAPI/public/social/redirect/'
                  //   // redirect_uri : 'https://www.facebook.com/connect/login_success.html'
                  //   // redirect_uri : 'index.html'
                  //   // redirect_uri : 'http://adodson.com/hello.js/redirect.html'
                  // });
                  socailProvider = 'facebook';
                  localStorage.setItem("network", socailProvider);
                  // hello('facebook').login({scope:'email, user_birthday'}, loginHandler);

                  FacebookInAppBrowser.settings.appId = '958239604218546';
                  FacebookInAppBrowser.settings.redirectUrl = 'http://starating.net/starating_league2015/StaRatingAPI/public/social/redirect2/';
                  FacebookInAppBrowser.settings.permissions = 'email,user_birthday';

                  // Optional
                  FacebookInAppBrowser.settings.timeoutDuration = 10000;

                  FacebookInAppBrowser.login({
                      send: function() {
                          console.log('login opened');
                      },
                      success: function(access_token) {
                          console.log('done, access token: ' + access_token);
                      },
                      denied: function() {
                          console.log('user denied');
                      },
                      timeout: function(){
                          console.log('a timeout has occurred, probably a bad internet connection');
                      },
                      complete: function(access_token) {
                          console.log('window closed');
                          if(access_token) {
                              console.log(access_token);
                              loginHandlerFB(access_token);
                          } else {
                              console.log('no access token');
                          }
                      },
                      userInfo: function(userInfo) {
                          if(userInfo) {
                              console.log(JSON.stringify(userInfo));
                          } else {
                              console.log('no user info');
                          }
                      }
                  });
                });

                $('#tw').on('click', function(){
                  socailProvider = 'twitter';
                  localStorage.setItem("network", socailProvider);
                  hello('twitter').login(loginHandler);
                });

                $('.content').show();
                $('.header').show();
                $('.under-header').show();
              }
              
          });
        </script>
        
    </head>
  <body onload="onLoad()">
    <div class="header" style="display:none;">
      <h2 class="header-title"><span class="header-title-dash">&mdash;</span> Log In <span class="header-title-dash">&mdash;</span></h2>
    </div>
    <div class="under-header" style="display:none;"></div>
    <div class="content" style="display:none;">
      <div class="inner-content">
        <h1 class="signup-title">Welcome Back</h1>
        <h2 class="signup-subtitle">Log in using any of the following</h2>
        <div class="dash-divider"></div>
        <div class="dash-divider-padding"></div>
        <div ontouchstart class="short-button fb" id='fb'>Facebook</div>
        <!-- <div class="short-button tw" id='tw'>Twitter</div> -->
        <a ontouchstart class="short-button" href='login.html'>Email</a>
        <div class="dash-divider-padding"></div>
        <div class="signup-bottom">
          <div class="dash-divider"></div>
        
          <h2 class="signup-subtitle2">New to all this?</h2>
          <a class="text-button text-button-bottom" href='index.html'>sign up</a>
        </div>
      </div>
    </div>
  </body>
</html>